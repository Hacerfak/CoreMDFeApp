<UserControl xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="clr-namespace:CoreMDFe.Desktop.ViewModels"
    xmlns:entities="clr-namespace:CoreMDFe.Core.Entities;assembly=CoreMDFe.Core"
    xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
    xmlns:conv="clr-namespace:CoreMDFe.Desktop.Converters"
    x:Class="CoreMDFe.Desktop.Views.HistoricoView"
    x:DataType="vm:HistoricoViewModel"
    x:Name="RootControl">

    <UserControl.Resources>
        <conv:StatusToBrushConverter x:Key="StatusToBrushConverter" />
    </UserControl.Resources>

    <Grid>
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="40" Spacing="20">

                <Grid ColumnDefinitions="*, Auto">
                    <StackPanel Grid.Column="0">
                        <TextBlock Text="Histórico de MDF-e" FontSize="28" FontWeight="Light"
                            Foreground="#222222" />
                        <TextBlock
                            Text="Gerencie manifestos, filtre por datas e realize eventos operacionais."
                            FontSize="14" Foreground="Gray" Margin="0,5,0,0" />
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="15"
                        VerticalAlignment="Center">
                        <StackPanel>
                            <TextBlock Text="Data Inicial" FontSize="11" FontWeight="SemiBold"
                                Foreground="Gray" Margin="0,0,0,5" />
                            <CalendarDatePicker SelectedDate="{Binding DataInicio}" Width="150"
                                Classes="Outline" />
                        </StackPanel>

                        <StackPanel>
                            <TextBlock Text="Data Final" FontSize="11" FontWeight="SemiBold"
                                Foreground="Gray" Margin="0,0,0,5" />
                            <CalendarDatePicker SelectedDate="{Binding DataFim}" Width="150"
                                Classes="Outline" />
                        </StackPanel>

                        <Button Command="{Binding CarregarHistoricoCommand}" Classes="Primary"
                            Theme="{StaticResource SolidButton}"
                            Background="#673AB7" Foreground="White" Padding="20,8" Margin="0,18,0,0"
                            CornerRadius="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <materialIcons:MaterialIcon Kind="Magnify" Width="20" Height="20" />
                                <TextBlock Text="Filtrar" VerticalAlignment="Center"
                                    FontWeight="Bold" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>

                <Border Background="#FFEBEE" Padding="15" CornerRadius="8"
                    IsVisible="{Binding HasErro}" Margin="0,10,0,0">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <materialIcons:MaterialIcon Kind="AlertCircleOutline" Foreground="#D32F2F"
                            Width="24" Height="24" />
                        <TextBlock Text="{Binding MensagemErro}" Foreground="#D32F2F"
                            FontWeight="SemiBold" TextWrapping="Wrap" VerticalAlignment="Center" />
                    </StackPanel>
                </Border>

                <Border Classes="Card" Padding="0" Margin="0,10,0,0">
                    <StackPanel>
                        <Border Background="#F8F9FA" Padding="20,15" BorderBrush="#EEEEEE"
                            BorderThickness="0,0,0,1" CornerRadius="8,8,0,0">
                            <Grid ColumnDefinitions="90, 110, *, 160, 90, 110, 200">
                                <TextBlock Grid.Column="0" Text="Nº / SÉRIE" FontWeight="Bold"
                                    FontSize="12" Foreground="Gray" />
                                <TextBlock Grid.Column="1" Text="EMISSÃO" FontWeight="Bold"
                                    FontSize="12" Foreground="Gray" />
                                <TextBlock Grid.Column="2" Text="CHAVE / PROTOCOLO"
                                    FontWeight="Bold" FontSize="12" Foreground="Gray" />
                                <TextBlock Grid.Column="3" Text="VEÍCULO / MOT" FontWeight="Bold"
                                    FontSize="12" Foreground="Gray" />
                                <TextBlock Grid.Column="4" Text="ROTA" FontWeight="Bold"
                                    FontSize="12" Foreground="Gray" />
                                <TextBlock Grid.Column="5" Text="STATUS" FontWeight="Bold"
                                    FontSize="12" Foreground="Gray" HorizontalAlignment="Center" />
                                <TextBlock Grid.Column="6" Text="AÇÕES" FontWeight="Bold"
                                    FontSize="12" Foreground="Gray" HorizontalAlignment="Center" />
                            </Grid>
                        </Border>

                        <ProgressBar IsIndeterminate="True" IsVisible="{Binding EstaCarregando}"
                            Height="2" Foreground="#673AB7" />

                        <ItemsControl ItemsSource="{Binding Manifestos}" x:CompileBindings="False">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderBrush="#EEEEEE" BorderThickness="0,0,0,1"
                                        Padding="20,15">
                                        <Grid ColumnDefinitions="90, 110, *, 160, 90, 110, 200">

                                            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Manifesto.Numero}"
                                                    FontWeight="Bold" FontSize="15"
                                                    Foreground="#333" />
                                                <TextBlock
                                                    Text="{Binding Manifesto.Serie, StringFormat='Série: {0}'}"
                                                    FontSize="12" Foreground="Gray" />
                                            </StackPanel>

                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock
                                                    Text="{Binding Manifesto.DataEmissao, StringFormat={}{0:dd/MM/yyyy}}"
                                                    FontWeight="SemiBold" Foreground="#555" />
                                                <TextBlock
                                                    Text="{Binding Manifesto.DataEmissao, StringFormat={}{0:HH:mm}}"
                                                    FontSize="12" Foreground="Gray" />
                                            </StackPanel>

                                            <StackPanel Grid.Column="2" VerticalAlignment="Center"
                                                Margin="0,0,15,0">
                                                <Button
                                                    Command="{Binding #RootControl.((vm:HistoricoViewModel)DataContext).CopiarChaveCommand}"
                                                    CommandParameter="{Binding Manifesto.ChaveAcesso}"
                                                    Classes="Flat" Padding="2"
                                                    Background="Transparent"
                                                    ToolTip.Tip="Clique para copiar a Chave"
                                                    HorizontalAlignment="Left">
                                                    <StackPanel Orientation="Horizontal" Spacing="5">
                                                        <TextBlock
                                                            Text="{Binding Manifesto.ChaveAcesso}"
                                                            FontSize="12" FontWeight="SemiBold"
                                                            Foreground="#2196F3"
                                                            TextTrimming="CharacterEllipsis"
                                                            MaxWidth="160" />
                                                        <materialIcons:MaterialIcon
                                                            Kind="ContentCopy" Width="14"
                                                            Height="14" Foreground="#2196F3" />
                                                    </StackPanel>
                                                </Button>
                                                <TextBlock
                                                    Text="{Binding Manifesto.ProtocoloAutorizacao, StringFormat='Prot: {0}', FallbackValue='Aguardando...'}"
                                                    FontSize="11" Foreground="Gray" Margin="2,0,0,0" />
                                            </StackPanel>

                                            <StackPanel Grid.Column="3" VerticalAlignment="Center"
                                                Margin="0,0,15,0">
                                                <TextBlock Text="{Binding Placa}" FontWeight="Bold"
                                                    FontSize="13" Foreground="#444" />
                                                <TextBlock Text="{Binding Condutor}" FontSize="11"
                                                    Foreground="Gray"
                                                    TextTrimming="CharacterEllipsis"
                                                    ToolTip.Tip="{Binding Condutor}" />
                                            </StackPanel>

                                            <StackPanel Grid.Column="4" Orientation="Horizontal"
                                                Spacing="5" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Manifesto.UfOrigem}"
                                                    FontWeight="Bold" Foreground="#333" />
                                                <materialIcons:MaterialIcon Kind="ArrowRight"
                                                    Width="14" Foreground="Gray" />
                                                <TextBlock Text="{Binding Manifesto.UfDestino}"
                                                    FontWeight="Bold" Foreground="#333" />
                                            </StackPanel>

                                            <Border Grid.Column="5" Padding="12,6" CornerRadius="20"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Background="{Binding Manifesto.Status, Converter={StaticResource StatusToBrushConverter}}">
                                                <TextBlock Text="{Binding Manifesto.Status}"
                                                    FontSize="11" FontWeight="Bold"
                                                    Foreground="White" />
                                            </Border>

                                            <StackPanel Grid.Column="6" Orientation="Horizontal"
                                                Spacing="3" HorizontalAlignment="Center"
                                                VerticalAlignment="Center">

                                                <Button Classes="Flat" Padding="6"
                                                    ToolTip.Tip="Reenviar para SEFAZ"
                                                    CornerRadius="8"
                                                    Command="{Binding #RootControl.((vm:HistoricoViewModel)DataContext).ReenviarCommand}"
                                                    CommandParameter="{Binding Manifesto}"
                                                    IsVisible="{Binding Manifesto.Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static entities:StatusManifesto.Rejeitado}}">
                                                    <materialIcons:MaterialIcon Kind="Send"
                                                        Width="20" Height="20" Foreground="#673AB7" />
                                                </Button>

                                                <Button Classes="Flat" Padding="6"
                                                    ToolTip.Tip="Editar e Corrigir MDF-e"
                                                    CornerRadius="8"
                                                    Command="{Binding #RootControl.((vm:HistoricoViewModel)DataContext).EditarRejeitadoCommand}"
                                                    CommandParameter="{Binding Manifesto}"
                                                    IsVisible="{Binding Manifesto.Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static entities:StatusManifesto.Rejeitado}}">
                                                    <materialIcons:MaterialIcon Kind="Pencil"
                                                        Width="20" Height="20" Foreground="#2196F3" />
                                                </Button>

                                                <Button Classes="Flat" Padding="6"
                                                    ToolTip.Tip="Imprimir DAMDFE" CornerRadius="8"
                                                    Command="{Binding #RootControl.((vm:HistoricoViewModel)DataContext).ImprimirCommand}"
                                                    CommandParameter="{Binding Manifesto}"
                                                    IsVisible="{Binding Manifesto.Status, Converter={x:Static ObjectConverters.NotEqual}, ConverterParameter={x:Static entities:StatusManifesto.Rejeitado}}">
                                                    <materialIcons:MaterialIcon Kind="Printer"
                                                        Width="20" Height="20" Foreground="#607D8B" />
                                                </Button>

                                                <Button Classes="Flat" Padding="6"
                                                    ToolTip.Tip="Encerrar Viagem" CornerRadius="8"
                                                    Command="{Binding #RootControl.((vm:HistoricoViewModel)DataContext).EncerrarCommand}"
                                                    CommandParameter="{Binding Manifesto}"
                                                    IsVisible="{Binding Manifesto.Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static entities:StatusManifesto.Autorizado}}">
                                                    <materialIcons:MaterialIcon
                                                        Kind="CheckCircleOutline" Width="20"
                                                        Height="20" Foreground="#4CAF50" />
                                                </Button>

                                                <Button Classes="Flat" Padding="6"
                                                    ToolTip.Tip="Cancelar MDF-e" CornerRadius="8"
                                                    Command="{Binding #RootControl.((vm:HistoricoViewModel)DataContext).AbrirDialogCancelarCommand}"
                                                    CommandParameter="{Binding Manifesto}"
                                                    IsVisible="{Binding Manifesto.Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static entities:StatusManifesto.Autorizado}}">
                                                    <materialIcons:MaterialIcon Kind="Cancel"
                                                        Width="20" Height="20" Foreground="#F44336" />
                                                </Button>

                                                <Button Classes="Flat" Padding="6"
                                                    ToolTip.Tip="Novo Condutor" CornerRadius="8"
                                                    Command="{Binding #RootControl.((vm:HistoricoViewModel)DataContext).AbrirDialogCondutorCommand}"
                                                    CommandParameter="{Binding Manifesto}"
                                                    IsVisible="{Binding Manifesto.Status, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static entities:StatusManifesto.Autorizado}}">
                                                    <materialIcons:MaterialIcon Kind="AccountPlus"
                                                        Width="20" Height="20" Foreground="#2196F3" />
                                                </Button>

                                                <Button Classes="Flat" Padding="6"
                                                    ToolTip.Tip="Nova Carga (DF-e)" CornerRadius="8"
                                                    Command="{Binding #RootControl.((vm:HistoricoViewModel)DataContext).AbrirDialogDFeCommand}"
                                                    CommandParameter="{Binding Manifesto}"
                                                    IsVisible="{Binding PodeIncluirDFe}">
                                                    <materialIcons:MaterialIcon
                                                        Kind="FileDocumentPlus" Width="20"
                                                        Height="20" Foreground="#FF9800" />
                                                </Button>

                                                <Button Classes="Flat" Padding="6"
                                                    ToolTip.Tip="Excluir MDF-e do Sistema"
                                                    CornerRadius="8"
                                                    Command="{Binding #RootControl.((vm:HistoricoViewModel)DataContext).AbrirDialogExcluirCommand}"
                                                    CommandParameter="{Binding Manifesto}">
                                                    <materialIcons:MaterialIcon Kind="DeleteForever"
                                                        Width="20" Height="20" Foreground="#F44336" />
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <StackPanel IsVisible="{Binding IsListaVazia}" HorizontalAlignment="Center"
                            Margin="0,50,0,50" Spacing="10">
                            <materialIcons:MaterialIcon Kind="TextBoxSearchOutline" Width="48"
                                Height="48" Foreground="#E0E0E0" HorizontalAlignment="Center" />
                            <TextBlock Text="Nenhum MDF-e encontrado neste período."
                                Foreground="Gray" FontSize="16" />
                        </StackPanel>

                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <Grid Background="#A0000000" IsVisible="{Binding IsDialogCancelarAberto}" ZIndex="100">
            <Border Background="White" CornerRadius="8" Padding="30" Width="400"
                VerticalAlignment="Center" HorizontalAlignment="Center"
                BoxShadow="0 10 30 0 #50000000">
                <StackPanel Spacing="15">
                    <TextBlock Text="Cancelar MDF-e" FontWeight="Bold" FontSize="18"
                        Foreground="#F44336" />
                    <TextBlock Text="Informe o motivo do cancelamento (Mínimo de 15 caracteres):"
                        TextWrapping="Wrap" Foreground="Gray" />
                    <TextBox Text="{Binding JustificativaCancelamento}" Height="80"
                        AcceptsReturn="True" TextWrapping="Wrap" Classes="Outline"
                        Theme="{StaticResource OutlineTextBox}" />
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10"
                        Margin="0,10,0,0">
                        <Button Content="Desistir" Command="{Binding FecharDialogosCommand}"
                            Classes="Flat" Foreground="Gray" />
                        <Button Content="Confirmar Cancelamento"
                            Command="{Binding ConfirmarCancelamentoCommand}" Background="#F44336"
                            Foreground="White" Theme="{StaticResource SolidButton}" />
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <Grid Background="#A0000000" IsVisible="{Binding IsDialogCondutorAberto}" ZIndex="100">
            <Border Background="White" CornerRadius="8" Padding="30" Width="400"
                VerticalAlignment="Center" HorizontalAlignment="Center"
                BoxShadow="0 10 30 0 #50000000">
                <StackPanel Spacing="15">
                    <TextBlock Text="Incluir Novo Condutor" FontWeight="Bold" FontSize="18"
                        Foreground="#2196F3" />
                    <TextBlock Text="Preencha os dados do motorista que assumirá o MDF-e."
                        TextWrapping="Wrap" Foreground="Gray" />
                    <TextBox Text="{Binding NovoCondutorNome}" Watermark="Nome Completo"
                        Classes="Outline" Theme="{StaticResource OutlineTextBox}" />
                    <TextBox Text="{Binding NovoCondutorCpf}" Watermark="CPF (Somente Números)"
                        Classes="Outline" Theme="{StaticResource OutlineTextBox}" />
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10"
                        Margin="0,10,0,0">
                        <Button Content="Cancelar" Command="{Binding FecharDialogosCommand}"
                            Classes="Flat" Foreground="Gray" />
                        <Button Content="Adicionar Condutor"
                            Command="{Binding ConfirmarInclusaoCondutorCommand}"
                            Background="#2196F3" Foreground="White"
                            Theme="{StaticResource SolidButton}" />
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <Grid Background="#A0000000" IsVisible="{Binding IsDialogExcluirAberto}" ZIndex="110">
            <Border Background="White" CornerRadius="8" Padding="30" Width="450"
                VerticalAlignment="Center" HorizontalAlignment="Center"
                BoxShadow="0 10 30 0 #50000000">
                <StackPanel Spacing="20">
                    <StackPanel Orientation="Horizontal" Spacing="15">
                        <materialIcons:MaterialIcon Kind="Alert" Width="32" Height="32"
                            Foreground="#F44336" />
                        <TextBlock Text="Confirmar Exclusão" FontWeight="Bold" FontSize="20"
                            Foreground="#333" VerticalAlignment="Center" />
                    </StackPanel>

                    <TextBlock
                        Text="Tem certeza que deseja excluir este MDF-e? Esta ação removerá permanentemente todos os dados vinculados (notas, veículos, condutores) da base de dados local."
                        TextWrapping="Wrap" Foreground="#555" />

                    <Border Background="#F5F5F5" Padding="15" CornerRadius="6">
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <TextBlock Text="MDF-e nº:" FontWeight="SemiBold" />
                            <TextBlock Text="{Binding ManifestoSelecionado.Numero}"
                                FontWeight="Bold" />
                            <TextBlock Text=" - Chave:" FontWeight="SemiBold" Margin="10,0,0,0" />
                            <TextBlock Text="{Binding ManifestoSelecionado.ChaveAcesso}"
                                TextTrimming="CharacterEllipsis" MaxWidth="150" />
                        </StackPanel>
                    </Border>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="15">
                        <Button Content="Não, cancelar" Command="{Binding FecharDialogosCommand}"
                            Classes="Flat" Foreground="Gray" Padding="20,10" />
                        <Button Content="Sim, excluir permanentemente"
                            Command="{Binding ConfirmarExclusaoCommand}"
                            Background="#F44336" Foreground="White"
                            Theme="{StaticResource SolidButton}"
                            Padding="20,10" CornerRadius="8" />
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <Border Background="#80000000" IsVisible="{Binding IsDialogDFeAberto}" ZIndex="100">
            <Border Background="White" CornerRadius="8" Padding="30" Width="650"
                VerticalAlignment="Center" HorizontalAlignment="Center"
                BoxShadow="0 10 30 0 #40000000">
                <StackPanel Spacing="20">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <materialIcons:MaterialIcon Kind="FileDocumentPlus" Width="28" Height="28"
                            Foreground="#2196F3" />
                        <TextBlock Text="Incluir Notas Fiscais (Carregamento Posterior)"
                            FontSize="20" FontWeight="Bold" Foreground="#333"
                            VerticalAlignment="Center" />
                    </StackPanel>

                    <TextBlock
                        Text="Selecione os ficheiros XML. O sistema extrairá automaticamente a origem, o destino e as chaves para registar o evento na SEFAZ."
                        Foreground="Gray" TextWrapping="Wrap" />

                    <Button Content="Procurar XMLs (NF-e / CT-e)"
                        Command="{Binding ProcurarXmlsParaInclusaoCommand}"
                        Classes="Outline" Foreground="#2196F3" BorderBrush="#2196F3"
                        HorizontalAlignment="Left" Padding="20,10">
                        <Button.Styles>
                            <Style Selector="Button:pointerover /template/ ContentPresenter">
                                <Setter Property="Background" Value="#E3F2FD" />
                            </Style>
                        </Button.Styles>
                    </Button>

                    <Border BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="4"
                        Margin="0,10,0,0">
                        <Grid RowDefinitions="Auto, *">

                            <Border Background="#EEEEEE" Padding="15,10" CornerRadius="4,4,0,0">
                                <Grid ColumnDefinitions="60, *, 150">
                                    <TextBlock Grid.Column="0" Text="TIPO" FontWeight="Bold"
                                        Foreground="#555" FontSize="12" />
                                    <TextBlock Grid.Column="1" Text="CHAVE DE ACESSO"
                                        FontWeight="Bold" Foreground="#555" FontSize="12" />
                                    <TextBlock Grid.Column="2" Text="DESCARREGAMENTO"
                                        FontWeight="Bold" Foreground="#555" FontSize="12" />
                                </Grid>
                            </Border>

                            <ListBox Grid.Row="1" ItemsSource="{Binding DocumentosInclusao}"
                                Height="180" Background="#F8F9FA" BorderThickness="0">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="60, *, 150" Margin="0,5">
                                            <TextBlock Grid.Column="0"
                                                Text="{Binding Tipo, StringFormat='{}00'}"
                                                VerticalAlignment="Center" FontWeight="Bold"
                                                Foreground="#673AB7" />
                                            <TextBlock Grid.Column="1" Text="{Binding Chave}"
                                                VerticalAlignment="Center" FontFamily="Consolas"
                                                FontSize="13" />
                                            <TextBlock Grid.Column="2"
                                                Text="{Binding MunicipioDescarga}"
                                                VerticalAlignment="Center" Foreground="#555" />
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>

                        </Grid>
                    </Border>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="15"
                        Margin="0,10,0,0">
                        <Button Content="Cancelar" Command="{Binding FecharDialogosCommand}"
                            Classes="Flat" Foreground="Gray" Padding="20,10" />
                        <Button Content="Confirmar Inclusão na SEFAZ"
                            Command="{Binding ConfirmarInclusaoDFeCommand}" Classes="Primary"
                            Theme="{StaticResource SolidButton}" Background="#2196F3"
                            Foreground="White" Padding="20,10" CornerRadius="8" />
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>